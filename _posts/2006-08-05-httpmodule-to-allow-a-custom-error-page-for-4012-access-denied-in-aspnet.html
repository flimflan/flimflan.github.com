---
title: HttpModule to allow a custom error page for 401.2 Access Denied in ASP.NET
permalink: HttpModuleToAllowACustomErrorPageFor4012AccessDeniedInASPNET.html
layout: migrated
date: 2006-08-05
id: ba11f114-6da4-4e79-9a0d-57402643baaf
published_at: 2006-08-05 12:02:52.412000000 -05:00
tags: .NET

---

As you know, the customErrors section of web.config allows you to define your own pages to display to the user when an error occurs. It allows for a default page to display when any unhandled error occurs, and it also allows you to specify different pages to display depending on the HTTP status code.<br /><br />I like to take advantage of ASP.NET's declarative security model by defining the users and roles that are authorized to execute different parts of my website. For example, I can limit access to a page named Protected.aspx by declaring that all users must be a meber of the VerySpecialUsers group. This can be accomplished by adding the following section to my web.config:<br /><br />
<div style="background: white none repeat scroll 0% 50%; font-family: Consolas; font-size: 10pt; color: black; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">location</span><span style="color: blue;"> </span><span style="color: red;">path</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">Protected.aspx</span>&quot;<span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &lt;</span><span style="color: maroon;">system.web</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &nbsp; &lt;</span><span style="color: maroon;">authorization</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &nbsp; &nbsp; &lt;</span><span style="color: maroon;">allow</span><span style="color: blue;"> </span><span style="color: red;">roles</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">VerySpecialUsers</span>&quot;<span style="color: blue;">/&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &nbsp; &nbsp; &lt;</span><span style="color: maroon;">deny</span><span style="color: blue;"> </span><span style="color: red;">users</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">*</span>&quot;<span style="color: blue;">/&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &nbsp; &lt;/</span><span style="color: maroon;">authorization</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &lt;/</span><span style="color: maroon;">system.web</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;/</span><span style="color: maroon;">location</span><span style="color: blue;">&gt;</span></p>
</div>
<br />I like this model as it allows me to easily modify the access restrictions for a page, and since it uses ASP.NET's Role Provider framework, it is not tied to any implementation about how role membership is determined. By default in a Windows Authentication/NTLM scenario, the roles map to the group memberships of your Windows login account (Administrators, Power Users, Users, etc). But you can <a href="/ASPNETRoleProviderVisualStudioTemplate.html">very easily create your own Role Provider</a> that retrieves group membership information from your own data store.<br /><br />When a user does not meet the authorization requirements to visit a certain page, ASP.NET will return a 401.2 Access Denied error. The page looks like the standard <a href="http://en.wikipedia.org/wiki/Yellow_Screen_of_Death">yellow screen of death</a> (YSOD) that ASP.NET returns for all errors.The customErrors section of web.config is supposed to let you provide a friendlier response to your users so they never have to see the YSOD. You would think that all you need to do is define a page for the 401 status code in customErrors and all would be good. You would be wrong. You can even try changing the custom error page defined in your IIS settings, and it still won't work.<br /><br />The newsgroups have countless unanswered posts about this issue. Fortunately, my most recent attempt to solve this problem finally found some answers. The first one I found, and the one I use for my solution, was <a href="http://forums.aspfree.com/showpost.php?p=100206&amp;postcount=5">posted by John &quot;iSpeakGeek&quot; on ASPFree forums</a>. I have since discovered a <a href="http://www.codeproject.com/aspnet/Custon401Page.asp">CodeProject article by George Mamaladze</a>, and even a (somewhat related) <a href="http://support.microsoft.com/default.aspx?scid=kb;en-us;902239">Microsoft KB article</a>. Hopefully this post will help improve the search results for other people struggling with this issue.<br /><br />The key to the solution is to intercept the EndRequest event of the page lifecycle, check for a 401 status code, and then execute your custom page. The Microsoft article suggests intercepting the Error event and checking for an UnauthroizedAccessException, but that didn't work for my scenario. It may only apply when using impersonation, as the article describes. I need to do more testing and will possibly modify my solution to cover more scenarios.<br /><br />Since I need this functionality on pretty much every website I make, I created an HttpModule to encapsulate the logic. The nice thing about my module approach is that you simply register the module in your web.config, and it will automatically respect the settings you define in your customErrors section. There is no hardcoded dependence on a specific error page or need for a custom configuration section.<br /><br />
<div style="background: white none repeat scroll 0% 50%; font-family: Consolas; font-size: 10pt; color: black; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
<p style="margin: 0px;"><span style="color: blue;">&lt;</span><span style="color: maroon;">httpModules</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">add</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">CustomAccessDenied</span>&quot;<span style="color: blue;"> </span><span style="color: red;">type</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">FlimFlan.CustomAccessDenied, FlimFlan.CustomAccessDenied</span>&quot;<span style="color: blue;">/&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&lt;/</span><span style="color: maroon;">httpModules</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&lt;</span><span style="color: maroon;">customErrors</span><span style="color: blue;"> </span><span style="color: red;">mode</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">On</span>&quot;<span style="color: blue;"> </span><span style="color: red;">defaultRedirect</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">Error.htm</span>&quot;<span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">error</span><span style="color: blue;"> </span><span style="color: red;">statusCode</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">401</span>&quot;<span style="color: blue;"> </span><span style="color: red;">redirect</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">AccessDenied.aspx</span>&quot;<span style="color: blue;">/&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&lt;/</span><span style="color: maroon;">customErrors</span><span style="color: blue;">&gt;</span></p>
</div>
<br />I've packaged up the full source and a sample website. Use it and change it as you wish. If you don't care about the source, just grab the DLL from the DemoWeb\Bin folder and put it in your own website's Bin folder.<br /><br />I can't claim it is a general purpose solution yet, as I have not tested it with all possible authentication/authorization settings. If you find a scenario that doesn't work, please let me know and I'll see if I can address it.<br /><br />Download <a href="/assets/downloads/FlimFlan_CustomAccessDenied.zip">FlimFlan.CustomAccessDenied</a>

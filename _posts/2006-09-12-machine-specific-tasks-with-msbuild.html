---
title: Machine specific tasks with MSBuild
permalink: MachineSpecificTasksWithMSBuild.html
layout: migrated
date: 2006-09-12
id: f110c144-dfdd-4f93-aa9c-8f27d9c05726
published_at: 2006-09-12 22:24:33.781000000 -05:00
tags: .NET

---

<p><a href="http://codebetter.com/blogs/jeremy.miller">Jeremy D. Miller</a> recently wrote about <a href="http://codebetter.com/blogs/jeremy.miller/archive/2006/09/11/Machine-specific-tasks-with-NAnt.aspx">how to make a NAnt script branch based on the machine</a> it's runnig on. Since I've been working almost exclusively with MSBuild, I figured it might be educational to post the equivalent script.</p>
<p>First, in Jeremy's example, he is really only changing the values of a property based on the machine name. If that is all you need to do, the MSBuild solution is fairly straightforward. I'll include the entire file contents so that you can easily copy/paste and test, and verify their are no hidden tricks.</p>
<div style="background: white none repeat scroll 0% 50%; font-size: 10pt; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; color: black; font-family: consolas;">
<p style="margin: 0px;"><span style="color: blue;">&lt;?</span><span style="color: maroon;">xml</span><span style="color: blue;"> </span><span style="color: red;">version</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">1.0</span>&quot;<span style="color: blue;"> </span><span style="color: red;">encoding</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">utf-8</span>&quot;<span style="color: blue;">?&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&lt;</span><span style="color: maroon;">Project</span><span style="color: blue;"> </span><span style="color: red;">DefaultTargets</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">Build</span>&quot;<span style="color: blue;"> </span><span style="color: red;">xmlns</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">http://schemas.microsoft.com/developer/msbuild/2003</span>&quot;<span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">PropertyGroup</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">Database</span><span style="color: blue;">&gt;</span>invoice_dev<span style="color: blue;">&lt;/</span><span style="color: maroon;">Database</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">Database</span><span style="color: blue;"> </span><span style="color: red;">Condition</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">'$(Computername)'=='TEST-SERVER'</span>&quot;<span style="color: blue;">&gt;</span>invoice_test<span style="color: blue;">&lt;/</span><span style="color: maroon;">Database</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">Database</span><span style="color: blue;"> </span><span style="color: red;">Condition</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">'$(Computername)'=='PRODUCTION-SERVER'</span>&quot;<span style="color: blue;">&gt;</span>invoice_prod<span style="color: blue;">&lt;/</span><span style="color: maroon;">Database</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;/</span><span style="color: maroon;">PropertyGroup</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;">&nbsp;</p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">Target</span><span style="color: blue;"> </span><span style="color: red;">Name</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">Build</span>&quot;<span style="color: blue;"> &gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">Message</span><span style="color: blue;"> </span><span style="color: red;">Text</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">Connect to database $(Database)</span>&quot;<span style="color: blue;"> /&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;/</span><span style="color: maroon;">Target</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&lt;/</span><span style="color: maroon;">Project</span><span style="color: blue;">&gt;</span></p>
</div>
<p>This takes advantage of the fact that all environment variables are immediately available as properties in an MSBuild script; and that all Windows machines (that I've worked on recently) have the COMPUTERNAME environment variable set.</p>
<p>However, if you actually needed to run different tasks (as opposed to just setting properties), things would look a little different. One way I might approach it would be:</p>
<div style="background: white none repeat scroll 0% 50%; font-size: 10pt; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; color: black; font-family: consolas;">
<p style="margin: 0px;"><span style="color: blue;">&lt;?</span><span style="color: maroon;">xml</span><span style="color: blue;"> </span><span style="color: red;">version</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">1.0</span>&quot;<span style="color: blue;"> </span><span style="color: red;">encoding</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">utf-8</span>&quot;<span style="color: blue;">?&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&lt;</span><span style="color: maroon;">Project</span><span style="color: blue;"> </span><span style="color: red;">DefaultTargets</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">Build</span>&quot;<span style="color: blue;"> </span><span style="color: red;">xmlns</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">http://schemas.microsoft.com/developer/msbuild/2003</span>&quot;<span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;">&nbsp;</p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">Target</span><span style="color: blue;"> </span><span style="color: red;">Name</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">Build</span>&quot;<span style="color: blue;"> </span><span style="color: red;">DependsOnTargets</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">MachineSpecificTasks</span>&quot;<span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">Message</span><span style="color: blue;"> </span><span style="color: red;">Text</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">Start Build</span>&quot;<span style="color: blue;"> /&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;/</span><span style="color: maroon;">Target</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;">&nbsp;</p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">Target</span><span style="color: blue;"> </span><span style="color: red;">Name</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">MachineSpecificTasks</span>&quot;<span style="color: blue;"> </span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; </span><span style="color: red;">DependsOnTargets</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">TestServers;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ProductionServers</span>&quot;<span style="color: blue;"> /&gt;</span></p>
<p style="margin: 0px;">&nbsp;</p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">Target</span><span style="color: blue;"> </span><span style="color: red;">Name</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">TestServers</span>&quot;<span style="color: blue;"> </span><span style="color: red;">Condition</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">'$(Computername)'=='TEST-SERVER1'</span>&quot;<span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">Message</span><span style="color: blue;"> </span><span style="color: red;">Text</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">Building on test server.</span>&quot;<span style="color: blue;"> /&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;/</span><span style="color: maroon;">Target</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;">&nbsp;</p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">Target</span><span style="color: blue;"> </span><span style="color: red;">Name</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">ProductionServers</span>&quot;<span style="color: blue;"> </span><span style="color: red;">Condition</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">'$(Computername)'=='PRODUCTION-SERVER1'</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OR '$(Computername)'=='PRODUCTION-SERVER2'</span>&quot;<span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">Message</span><span style="color: blue;"> </span><span style="color: red;">Text</span><span style="color: blue;">=</span>&quot;<span style="color: blue;">Building on production server.</span>&quot;<span style="color: blue;"> /&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;/</span><span style="color: maroon;">Target</span><span style="color: blue;">&gt;</span></p>
<p style="margin: 0px;"><span style="color: blue;">&lt;/</span><span style="color: maroon;">Project</span><span style="color: blue;">&gt;</span></p>
</div>
<p>I created a separate dummy target called MachineSpecificTasks. It is just used to define the different targets that you make available for each environment.&nbsp;I make all of the machine specific targets as dependencies on this target, so that the script will attempt to execute each of them. I&nbsp;could have just&nbsp;as easily skipped the MachineSpecificTasks target and&nbsp;put the dependencies on my Build target, but I felt that&nbsp;list might get large and&nbsp;get confusing. Better to hide it away.&nbsp;I then set a condition on each target so that it is only run if the computername environment variable&nbsp;matches the given computer name. I went a little further and showed how you could associate multiple computer names (PRODUCTION-SERVER1 and PRODUCTION-SERVER2) with the same set of tasks (collectively called ProductionServers).</p>
<p>There is probably a way to use the CallTarget task to more closely match the look of the NAnt solution, but I'm not sure if it would buy you anything.</p>
<p>Hope that helps.</p>
